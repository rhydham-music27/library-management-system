{% extends 'base.html' %}
{% block title %}Books - Library Management System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">Book Catalog</h2>
  {% if current_user.is_authenticated and (current_user.is_librarian() or current_user.is_admin()) %}
    <a class="btn btn-primary" href="{{ url_for('catalog.add_book') }}"><i class="bi bi-plus-circle"></i> Add New Book</a>
  {% endif %}
</div>

<div class="card mb-3">
  <div class="card-body">
    <form method="get" class="row g-2 align-items-end search-form">
      {{ form.hidden_tag() }}
      <div class="col-md-4">
        <label class="form-label">Search</label>
        {{ form.query(class='form-control', placeholder='Search by title, author, or ISBN') }}
      </div>
      <div class="col-md-3">
        <label class="form-label">Category</label>
        {{ form.category_id(class='form-select') }}
      </div>
      <div class="col-md-3">
        <label class="form-label">Availability</label>
        {{ form.availability(class='form-select') }}
      </div>
      <div class="col-md-2 d-flex gap-2">
        <button type="submit" class="btn btn-primary w-100"><i class="bi bi-search"></i> Search</button>
        <a href="{{ url_for('catalog.books') }}" class="btn btn-outline-secondary w-100" onclick="clearSearchFilters(); return false;">Clear</a>
      </div>
    </form>
  </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-2">
  <div class="text-muted">Showing {{ pagination.total }} books</div>
</div>

{% if pagination.total > 0 %}
<div class="table-responsive">
  <table class="table table-hover align-middle">
    <thead>
      <tr>
        <th>ISBN</th>
        <th>Title</th>
        <th>Author</th>
        <th>Category</th>
        <th class="text-center">Qty</th>
        <th>Availability</th>
        <th class="text-end">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for book in pagination.items %}
      <tr>
        <td>{{ book.isbn or 'N/A' }}</td>
        <td><a href="{{ url_for('catalog.book_detail', book_id=book.id) }}" class="fw-semibold">{{ book.title }}</a></td>
        <td>{{ book.author }}</td>
        <td>{{ book.category.name if book.category else 'Uncategorized' }}</td>
        <td class="text-center">{{ book.quantity }}</td>
        <td>
          {% if book.is_available %}
            <span class="badge bg-success">Available</span>
          {% else %}
            <span class="badge bg-danger">Unavailable</span>
          {% endif %}
        </td>
        <td class="text-end table-actions">
          <div class="btn-group btn-group-sm" role="group">
            <a href="{{ url_for('catalog.book_detail', book_id=book.id) }}" class="btn btn-outline-secondary">View</a>
            {% if current_user.is_authenticated and (current_user.is_librarian() or current_user.is_admin()) %}
              <a href="{{ url_for('catalog.edit_book', book_id=book.id) }}" class="btn btn-outline-primary">Edit</a>
              <form method="post" action="{{ url_for('catalog.delete_book', book_id=book.id) }}" class="d-inline" id="del-book-{{ book.id }}">
                <button type="submit" class="btn btn-outline-danger" onclick="confirmDelete('book', '{{ book.title|e }}', 'del-book-{{ book.id }}'); return false;">Delete</button>
              </form>
            {% endif %}
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<nav aria-label="Books pages">
  <ul class="pagination">
    <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('catalog.books', page=pagination.prev_num, query=query, category_id=category_id, availability=availability) if pagination.has_prev else '#' }}">Previous</a>
    </li>
    {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
      {% if p %}
        <li class="page-item {% if p == pagination.page %}active{% endif %}"><a class="page-link" href="{{ url_for('catalog.books', page=p, query=query, category_id=category_id, availability=availability) }}">{{ p }}</a></li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">â€¦</span></li>
      {% endif %}
    {% endfor %}
    <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('catalog.books', page=pagination.next_num, query=query, category_id=category_id, availability=availability) if pagination.has_next else '#' }}">Next</a>
    </li>
  </ul>
</nav>
{% else %}
  <div class="empty-state text-center py-5 text-muted">
    <i class="bi bi-journal-x fs-1 d-block mb-2"></i>
    No books found. Try adjusting filters{% if current_user.is_authenticated and (current_user.is_librarian() or current_user.is_admin()) %} or <a href="{{ url_for('catalog.add_book') }}">add your first book</a>{% endif %}.
  </div>
{% endif %}
{% endblock %}
