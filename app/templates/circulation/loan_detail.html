{% extends 'base.html' %}
{% block title %}Loan Details - Library Management System{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
    <li class="breadcrumb-item"><a href="{{ url_for('circulation.loans') }}">Circulation</a></li>
    <li class="breadcrumb-item active" aria-current="page">Loan #{{ loan.id }}</li>
  </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">Loan #{{ loan.id }}</h2>
  <div class="btn-group">
    <a href="{{ url_for('circulation.loans') }}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Back to Loans</a>
    {% if loan.is_active %}
    <a href="{{ url_for('circulation.return_book', loan_id=loan.id) }}" class="btn btn-success"><i class="bi bi-journal-arrow-up"></i> Return Book</a>
    {% endif %}
  </div>
</div>

<div class="row g-3">
  <div class="col-md-8">
    <div class="card loan-detail-card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span class="fw-semibold">Loan #{{ loan.id }}</span>
        <span class="badge {{ loan.status_badge_class }}">{{ loan.status.value.title() }}</span>
      </div>
      <div class="card-body">
        <dl class="row mb-0">
          <dt class="col-sm-3">Book</dt>
          <dd class="col-sm-9"><a href="{{ url_for('catalog.book_detail', book_id=loan.book.id) }}">{{ loan.book.title }}</a> <span class="text-muted">by {{ loan.book.author }}</span></dd>

          <dt class="col-sm-3">Member</dt>
          <dd class="col-sm-9"><a href="{{ url_for('members.member_detail', member_id=loan.member.id) }}">{{ loan.member.name }}</a> <span class="text-muted">({{ loan.member.member_id }})</span></dd>

          <dt class="col-sm-3">Borrow Date</dt>
          <dd class="col-sm-9">{{ loan.borrow_date.strftime('%b %d, %Y') }}</dd>

          <dt class="col-sm-3">Due Date</dt>
          <dd class="col-sm-9">{{ loan.due_date.strftime('%b %d, %Y') }}{% if loan.is_overdue %} <span class="text-danger fw-semibold">(Overdue {{ loan.days_overdue }} days)</span>{% endif %}</dd>

          <dt class="col-sm-3">Return Date</dt>
          <dd class="col-sm-9">{{ loan.return_date.strftime('%b %d, %Y') if loan.return_date else 'Not yet returned' }}</dd>

          <dt class="col-sm-3">Days Borrowed</dt>
          <dd class="col-sm-9">{{ days_borrowed }} day(s)</dd>
          <dt class="col-sm-3">Fine Amount</dt>
          <dd class="col-sm-9">
            {% if loan.fine_amount and loan.fine_amount|float > 0 %}
              ${{ '%.2f' % loan.fine_amount }}
              <small class="text-muted">({{ loan.days_overdue }} days Ã— ${{ '%.2f' % fine_rate }}/day)</small>
            {% else %}
              <span class="text-muted">No fine</span>
            {% endif %}
          </dd>
          <dt class="col-sm-3">Fine Paid</dt>
          <dd class="col-sm-9">${{ '%.2f' % (loan.fine_paid or 0) }}</dd>
          <dt class="col-sm-3">Fine Balance</dt>
          <dd class="col-sm-9">
            {% if loan.has_unpaid_fines %}
              <span class="text-danger fw-bold">${{ '%.2f' % loan.fine_balance }}</span>
            {% else %}
              <span class="text-success">Paid in full</span>
            {% endif %}
          </dd>
        </dl>

        {% if loan.notes %}
        <hr />
        <div>
          <div class="text-muted small mb-1">Notes</div>
          <div class="text-muted">{{ loan.notes }}</div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card mb-3">
      <div class="card-header bg-white">Status</div>
      <div class="card-body">
        <div class="mb-2"><span class="badge {{ loan.status_badge_class }} fs-6">{{ loan.status.value.title() }}</span></div>
        {% if loan.is_overdue %}
          <div class="text-danger">This loan is overdue by {{ loan.days_overdue }} day(s).</div>
        {% endif %}
        {% if loan.has_unpaid_fines %}
          <div class="text-warning mt-2">Outstanding fine: ${{ '%.2f' % loan.fine_balance }}</div>
          <a href="{{ url_for('circulation.pay_fine', loan_id=loan.id) }}" class="btn btn-warning w-100 mt-2"><i class="bi bi-currency-dollar"></i> Pay Fine</a>
        {% endif %}
        {% if loan.is_active %}
        <a href="{{ url_for('circulation.return_book') }}" class="btn btn-success w-100 mt-2"><i class="bi bi-journal-arrow-up"></i> Return Book</a>
        {% endif %}
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header bg-white">Related</div>
      <div class="card-body d-grid gap-2">
        <a href="{{ url_for('catalog.book_detail', book_id=loan.book.id) }}" class="btn btn-outline-primary btn-sm"><i class="bi bi-journal-text"></i> View Book Details</a>
        <a href="{{ url_for('members.member_detail', member_id=loan.member.id) }}" class="btn btn-outline-primary btn-sm"><i class="bi bi-person"></i> View Member Details</a>
        <a href="{{ url_for('circulation.member_history', member_id=loan.member.id) }}" class="btn btn-outline-primary btn-sm"><i class="bi bi-clock-history"></i> View Member History</a>
        <a href="{{ url_for('circulation.book_history', book_id=loan.book.id) }}" class="btn btn-outline-primary btn-sm"><i class="bi bi-clock-history"></i> View Book History</a>
      </div>
    </div>

    <div class="card">
      <div class="card-header bg-white">Metadata</div>
      <div class="card-body text-muted small">
        <div><i class="bi bi-calendar-plus me-2"></i>Created {{ loan.created_at.strftime('%b %d, %Y %I:%M %p') if loan.created_at else 'N/A' }}</div>
        <div><i class="bi bi-arrow-repeat me-2"></i>Last updated {{ loan.updated_at.strftime('%b %d, %Y %I:%M %p') if loan.updated_at else 'N/A' }}</div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
