{% extends 'base.html' %}
{% block title %}{{ member.name }} - Library Management System{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
    <li class="breadcrumb-item"><a href="{{ url_for('members.members') }}">Members</a></li>
    <li class="breadcrumb-item active" aria-current="page">{{ member.name }}</li>
  </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">{{ member.name }}</h2>
  <div class="btn-group">
    <a href="{{ url_for('members.members') }}" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Back to Members</a>
    <a href="{{ url_for('members.edit_member', member_id=member.id) }}" class="btn btn-primary"><i class="bi bi-pencil"></i> Edit Member</a>
    <form id="del-member-{{ member.id }}" class="d-inline" method="post" action="{{ url_for('members.delete_member', member_id=member.id) }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <button type="button" class="btn btn-outline-danger" onclick="confirmDelete('member', '{{ member.name|e }}', 'del-member-{{ member.id }}')"><i class="bi bi-trash"></i> Delete</button>
    </form>
  </div>
</div>

<div class="row g-3">
  <div class="col-md-8">
    <div class="card member-detail-card">
      <div class="card-header bg-white d-flex align-items-center justify-content-between">
        <div>
          <span class="fw-semibold">Member</span>
        </div>
        <span class="badge {{ member.status_badge_class }}">{{ member.status.value.title() }}</span>
      </div>
      <div class="card-body">
        <dl class="row mb-0">
          <dt class="col-sm-4">Member ID</dt>
          <dd class="col-sm-8"><span class="member-id" onclick="copyMemberIdToClipboard('{{ member.member_id }}')" title="Click to copy" data-bs-toggle="tooltip">{{ member.member_id }}</span></dd>

          <dt class="col-sm-4">Email</dt>
          <dd class="col-sm-8"><a href="mailto:{{ member.email }}">{{ member.email }}</a></dd>

          <dt class="col-sm-4">Phone</dt>
          <dd class="col-sm-8">{{ member.phone or 'Not provided' }}</dd>

          <dt class="col-sm-4">Address</dt>
          <dd class="col-sm-8">{{ member.address or 'Not provided' }}</dd>

          <dt class="col-sm-4">Registration Date</dt>
          <dd class="col-sm-8">{{ member.registration_date.strftime('%b %d, %Y') if member.registration_date else '' }}</dd>

          <dt class="col-sm-4">Member Since</dt>
          <dd class="col-sm-8">{{ (member.registration_date.strftime('%Y')) if member.registration_date else '' }}</dd>
        </dl>

        {% if member.notes %}
        <hr />
        <div>
          <div class="text-muted small mb-1">Internal Notes</div>
          <div class="text-muted">{{ member.notes }}</div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card mb-3">
      <div class="card-header bg-white">Status</div>
      <div class="card-body">
        <div class="mb-3"><span class="badge {{ member.status_badge_class }} fs-6">{{ member.status.value.title() }}</span></div>
        <div class="d-grid gap-2">
          {% if not member.is_active %}
          <form method="post" action="{{ url_for('members.change_status', member_id=member.id, new_status='active') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <button type="submit" class="btn btn-success status-action-btn" onclick="return confirmStatusChange('{{ member.member_id }}', '{{ member.status.value }}', 'active');"><i class="bi bi-check2-circle"></i> Activate</button>
          </form>
          {% endif %}
          {% if not member.is_suspended %}
          <form method="post" action="{{ url_for('members.change_status', member_id=member.id, new_status='suspended') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <button type="submit" class="btn btn-warning status-action-btn" onclick="return confirmStatusChange('{{ member.member_id }}', '{{ member.status.value }}', 'suspended');"><i class="bi bi-pause-circle"></i> Suspend</button>
          </form>
          {% endif %}
          {% if not member.is_expired %}
          <form method="post" action="{{ url_for('members.change_status', member_id=member.id, new_status='expired') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <button type="submit" class="btn btn-secondary status-action-btn" onclick="return confirmStatusChange('{{ member.member_id }}', '{{ member.status.value }}', 'expired');"><i class="bi bi-calendar-x"></i> Mark as Expired</button>
          </form>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header bg-white">Borrowing Statistics</div>
      <div class="card-body">
        <div class="d-flex justify-content-between"><span>Total borrowed</span><span class="fw-semibold">{{ total_borrowed }}</span></div>
        <div class="d-flex justify-content-between"><span>Currently borrowed</span><span class="fw-semibold">{{ currently_borrowed }}</span></div>
        <div class="d-flex justify-content-between"><span>Overdue books</span><span class="fw-semibold">{{ overdue_books }}</span></div>
        <a href="{{ url_for('circulation.member_history', member_id=member.id) }}" class="btn btn-outline-primary btn-sm w-100 mt-2">View Borrowing History</a>
      </div>
    </div>

    <div class="card mt-3">
      <div class="card-header bg-white">Metadata</div>
      <div class="card-body">
        <div class="d-flex justify-content-between"><span>Registered on</span><span>{{ member.registration_date.strftime('%b %d, %Y') if member.registration_date else '' }}</span></div>
        <div class="d-flex justify-content-between"><span>Last updated</span><span>{{ member.updated_at.strftime('%b %d, %Y') if member.updated_at else '' }}</span></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
